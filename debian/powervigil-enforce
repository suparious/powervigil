#!/bin/bash
# PowerVigilâ„¢ Enforcement Script

# Disable console blanking
setterm -blank 0 -powersave off -powerdown 0 2>/dev/null || true
echo 0 > /sys/module/kernel/parameters/consoleblank 2>/dev/null || true

# Disable DPMS if X is running
if [ -n "$DISPLAY" ] || [ -n "$WAYLAND_DISPLAY" ]; then
    export DISPLAY=${DISPLAY:-:0}
    xset -dpms 2>/dev/null || true
    xset s noblank 2>/dev/null || true
    xset s off 2>/dev/null || true
    xset s 0 0 2>/dev/null || true
fi

# CPU Performance
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
    echo "performance" > "$cpu" 2>/dev/null || true
done

# USB no autosuspend
for i in /sys/bus/usb/devices/*/power/control; do
    echo "on" > "$i" 2>/dev/null || true
done

# GPU settings
if command -v nvidia-smi &> /dev/null; then
    nvidia-smi -pm 1 2>/dev/null || true
fi

if [ -d /sys/class/drm/card0/device ]; then
    echo "performance" > /sys/class/drm/card0/device/power_dpm_state 2>/dev/null || true
    echo "high" > /sys/class/drm/card0/device/power_dpm_force_performance_level 2>/dev/null || true
fi

exit 0
